#!/bin/bash

#=================================================
# CONFIG
#=================================================

# Import YunoHost helpers
source /usr/share/yunohost/helpers
source _common.sh

ynh_abort_if_errors

# -------------------------------------------------------------
# Validators
# -------------------------------------------------------------

validate__moderators() {
    local email_regex='^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    local invalid_lines=""
    while IFS= read -r line; do
        if [[ ! $line =~ $email_regex ]] && [[ ! -z "$line" ]]; then
            invalid_lines+="$line\n"
        fi
    done <<< "$moderators"

    if [[ ! -z "$invalid_lines" ]]; then
        echo -e "Invalid email addresses found in moderators list:\n$invalid_lines"
    fi
}

# -------------------------------------------------------------
# Getters
# -------------------------------------------------------------

get__closedlist() {
    if [ -f "$control_dir/closedlist" ]; then
        echo "1"
    else
        echo "0"
    fi
}

get__prefix() {
    local prefix_file="$control_dir/prefix"


    [ -f "$prefix_file" ] || touch "$prefix_file"

    head -n 1 "$prefix_file"
#   head -n 1 "$prefix_file" | sed 's/[\[\]]//g'
#   head -n 1 "$prefix_file" | tr -d '[]'
#   cat "$prefix_file"

}

get__moderated() {
    if [ -f "$control_dir/moderated" ]; then
        echo "1"
    else
        echo "0"
    fi
}

# -------------------------------------------------------------
# Setters
# -------------------------------------------------------------

set__closedlist() {
    if [[ $closedlist == 1 ]]; then
        touch "$control_dir/closedlist"
        ynh_print_info "--message='Created $control_dir/closedlist for closedlist'"
    else
        ynh_secure_remove "$control_dir/closedlist"
        ynh_print_info "--message='Removed $control_dir/closedlist for closedlist'"
    fi
}

set__prefix() {
    local prefix_file="$control_dir/prefix"
    if [ -n "$prefix" ]; then
        echo "$prefix" > "$prefix_file"
#        echo "[$prefix]" > "$prefix_file"
    else
        sed -i '1d' "$prefix_file"
    fi
}

set__moderated() {
    if [[ $moderated == 1 ]]; then
        touch "$control_dir/moderated"
        ynh_print_info "--message='Created $control_dir/moderated for moderated'"
    else
        ynh_secure_remove "$control_dir/moderated"
        ynh_print_info "--message='Removed $control_dir/moderated for moderated'"
    fi
}

# -------------------------------------------------------------
# Config apply
# -------------------------------------------------------------

ynh_app_config_run $1
