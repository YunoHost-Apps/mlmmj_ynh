#!/bin/bash

# -------------------------------------------------------------
# mlmmj Removal Script for YunoHost
# -------------------------------------------------------------

# Import YunoHost helpers
source /usr/share/yunohost/helpers
source _common.sh

# Retrieve arguments from YunoHost configuration
app=$YNH_APP_INSTANCE_NAME
LISTNAME=$(ynh_app_setting_get --app=$app --key=list_name)

# Define paths
APP_ROOT="/var/spool/mlmmj"
SYMLINK_DIR="$APP_ROOT/$domain"
INSTALL_DIR="$APP_ROOT/$LISTNAME"

# -------------------------------------------------------------
# Remove Mailing List and Related Configurations
# -------------------------------------------------------------

ynh_script_progression --message="Removing mailing list $LISTNAME and related configurations;" --weight=10

# Remove the mailing list directory
ynh_secure_remove --file="$INSTALL_DIR"

# Remove the symbolic link
if [ -L "$SYMLINK_DIR/$LISTNAME" ]; then
    ynh_secure_remove --file="$SYMLINK_DIR/$LISTNAME"
fi

# Check and remove domain directory if empty
if [ -d "$SYMLINK_DIR" ] && [ ! "$(ls -A $SYMLINK_DIR)" ]; then
    ynh_secure_remove --file="$SYMLINK_DIR"
fi

# Remove the cron job
ynh_secure_remove --file="/etc/cron.d/$app"

# -------------------------------------------------------------
# Check for Remaining mlmmj Instances and Remove Binaries
# -------------------------------------------------------------

ynh_script_progression --message="Checking for remaining mlmmj instances;" --weight=10

mlmmj_instances=$(sudo yunohost app list | grep -c 'id: mlmmj')

# Remove mlmmj binaries and man pages only if this is the last instance
if [ "$mlmmj_instances" -eq 1 ]; then
    ynh_script_progression --message="Removing mlmmj binaries and man pages as this is the last instance;" --weight=10

    dirbin="/usr/local/bin/"
    dirman="/usr/local/share/man/man1/"
    pattern="mlmmj-*"

    for file in $dirbin$pattern; do
        ynh_secure_remove --file="$file"
    done

    for file in $dirman$pattern; do
        ynh_secure_remove --file="$file"
    done
fi

# -------------------------------------------------------------
# Completion of Script
# -------------------------------------------------------------

ynh_script_progression --message="Removal of $app completed" --last
