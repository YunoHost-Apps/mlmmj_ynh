#!/bin/bash

#=================================================
# INSTALL
#=================================================

# Import YunoHost helpers
source /usr/share/yunohost/helpers
source _common.sh

# -------------------------------------------------------------
# Check name validity
# -------------------------------------------------------------

is_valid_listname() {
    # Check format
    if ! [[ $1 =~ ^[a-z0-9]+([.-][a-z0-9]+)*$ ]]; then
        ynh_print_err --message="Invalid mailing list name. It must be lowercase and can only contain letters, numbers, dots, and dashes."
        return 1
    fi

    # Check if name is a username
    if yunohost user list --output-as plain | grep -q "^$1$"; then
        ynh_print_err --message="The mailing list name '$1' is already in use as a username. Please choose a different name."
        return 1
    fi

    return 0
}

if ! is_valid_listname "$list_name"; then
    ynh_die --message="Validation failed for list name: $list_name"
fi

# -------------------------------------------------------------
# Install MLMMJ if necessary and check Postfix
# -------------------------------------------------------------

install_update_mlmmj "$REQUIRED_VERSION"

# -------------------------------------------------------------
# Mailing List Creation and Activation
# -------------------------------------------------------------

ynh_script_progression --message="Creating the list $list_name@$domain at $install_dir;"

for DIR in incoming queue queue/discarded archive text subconf unsubconf \
           bounce control moderation subscribers.d digesters.d requeue \
           nomailsubs.d
do
    mkdir -p "$install_dir/$DIR"
done
chown mlmmj_pfx $MLMMJ_ROOT -R

echo "postmaster" > "$install_dir/control/owner"
echo "$list_name@$domain" > "$install_dir/control/listaddress"

if [ -d "$lang_dir" ]; then
    cp "$lang_dir"/* "$install_dir/text"
fi

yunohost user group create "${app}_owner"
yunohost user group create "${app}_moderators"
yunohost user group create "${app}_submod"
yunohost user group add ${app}_owner $owner


echo -e "owner:\nmoderators:\nsubmod:" > "/etc/yunohost/apps/$app/users.yml"

# -------------------------------------------------------------
# Setting up conf files transport et virtual
# -------------------------------------------------------------

if [ ! -d "$TABLES_DIR" ]; then
    mkdir -p "$TABLES_DIR"
fi

if ! grep -qF "$transport_entry" "$TRANSPORT_FILE"; then
    echo "$transport_entry" >> "$TRANSPORT_FILE"
    postmap "$TRANSPORT_FILE"
fi

if ! grep -qF "$virtual_entry" "$VIRTUAL_FILE"; then
    echo "$virtual_entry" >> "$VIRTUAL_FILE"
    postmap "$VIRTUAL_FILE"
fi

# -------------------------------------------------------------
# Symlinks for easier CLI administration
# -------------------------------------------------------------

if [ ! -d "$symlink_dir" ]; then
    mkdir -p "$symlink_dir"
fi
ln -s "$install_dir" "$symlink_dir/$list_name"

# -------------------------------------------------------------
# Cron
# -------------------------------------------------------------

rand_min=$(shuf -i 0-59 -n 1) # Generate random minute execution (between 0 and 59)
if [ ! -d "$CRON_DIR" ]; then
    mkdir -p "$CRON_DIR"
    chmod 644 "$CRON_DIR"
fi
echo "$rand_min */2 * * * root $MLMMJMAINTD -F -L $install_dir" > "$cron_file" 

# -------------------------------------------------------------
# Default settings
# -------------------------------------------------------------

#current_mode=$(ynh_app_setting_get --app=$app --key=moderators_update_mode)
#if [ -z "$current_mode" ]; then
#    ynh_app_setting_set --app=$app --key=moderators_update_mode --value="automatic"
#fi
ynh_app_setting_set --app=$app --key=mods_mode --value="yunohost"
ynh_app_setting_set --app=$app --key=mods_group --value=""

touch "$control_dir/moderators"
touch "$control_dir/subonlypost"
echo "[$list_name]" > "$control_dir/prefix"
echo "postmaster@$domain" > "$control_dir/owner"
touch "$control_dir/notifysub"
touch "$control_dir/subonlyget"
echo "postfix" > "$control_dir/verp"
touch "$control_dir/nodigestsub"
touch "$control_dir/nonomailsub"
echo "10485760" > "$control_dir/maxmailsize"  # 10MB

[ -f "../conf/footer_${language}.tpl" ] && footer_template="footer_${language}.tpl" || footer_template="footer_en.tpl"



# ------------

ynh_add_config --template="$footer_template" --destination="$install_dir/control/footer"
if [ ! -f "$app_sudoers_file" ]; then
    touch "$app_sudoers_file"
    chmod 440 "$app_sudoers_file"
fi

# Ajout de la rÃ¨gle pour www-data
echo "www-data ALL=(mlmmj_pfx) NOPASSWD: /chemin/vers/list-$app" >> "$app_sudoers_file"

# -------------


ynh_add_config --template="../conf/list.tpl" --destination="$bin_dir/list_$app"

# -------------------------------------------------------------
# Install completion
# -------------------------------------------------------------

ynh_script_progression --message="Mailing list $list_name@$domain was created successfully." --last
