#!/bin/bash

# -------------------------------------------------------------
# mlmmj installation script for YunoHost
# -------------------------------------------------------------

# Import YunoHost helpers
source /usr/share/yunohost/helpers

# Variables
RELEASE_URL="https://codeberg.org/mlmmj/mlmmj/archive/RELEASE_1_4_0rc2.tar.gz"
SPOOL_DIR="/var/spool/mlmmj"
INSTALL_FLAG=false
REQUIRED_VERSION="1.4.0.rc2"

# Checking prerequisites existing mlmmj binariesâ€¦
ynh_script_progression --message="Checking existing mlmmj binaries;"

# Checking if mlmmj is already installed
if command -v mlmmj-list >/dev/null 2>&1; then
    INSTALLED_VERSION=$(mlmmj-list -V | cut -d ' ' -f3)
    ynh_script_progression --message="mlmmj is already installed with version: $INSTALLED_VERSION"
    
    if [ "$REQUIRED_VERSION" != "$INSTALLED_VERSION" ]; then
        ynh_script_progression --message="Updating mlmmj to the required version;"
        INSTALL_FLAG=true
    fi
else
    ynh_script_progression --message="mlmmj is not installed, proceeding with installation;"
    INSTALL_FLAG=true
fi

# Installation update of mlmmj if necessary
if [ "$INSTALL_FLAG" = true ]; then
    ynh_install_app_dependencies autoconf make gcc libatf-dev
    ynh_script_progression --message="Downloading mlmmj release;"
    ynh_setup_source "$RELEASE_URL" mlmmj-release
    tar xzf mlmmj-release/RELEASE_1_4_0rc2.tar.gz -C mlmmj-release
    pushd mlmmj-release/mlmmj-1.4.0rc2
    autoreconf -i && ./configure && make && sudo make install
    popd
    ynh_secure_remove mlmmj-release
fi

# Retrieve arguments from TOML configuration
list_name=$(ynh_app_setting_get --app=$app --key=list_name)
domain=$(ynh_app_setting_get --app=$app --key=domain)

# Creating the mailing list
ynh_script_progression --message="Creating the mailing list;"
/usr/local/bin/mlmmj-make-ml -L $list_name -d $domain -a || ynh_die "Failed to create the mailing list."

# Running newaliases
ynh_script_progression --message="Running newaliases to update aliases."
newaliases || ynh_die "Failed to run newaliases"

# Activating and starting the mlmmj-maintd service
ynh_script_progression --message="Activating and starting the mlmmj-maintd service;"
ynh_systemd_action --service_name=mlmmj-maintd@$list_name.service --action=enable
ynh_systemd_action --service_name=mlmmj-maintd@$list_name.service --action=start || ynh_die "Failed to start mlmmj-maintd service"

ynh_script_progression --message="mlmmj installation and configuration completed."
