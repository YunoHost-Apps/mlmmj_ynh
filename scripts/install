#!/bin/bash

# -------------------------------------------------------------
# mlmmj installation script for YunoHost
# -------------------------------------------------------------

# Variables
SOURCE_URL="https://codeberg.org/mlmmj/listtexts"
SPOOL_DIR="/var/spool/mlmmj"
MLMMJ_USER="mlmmj"
MLMMJ_GROUP="mlmmj"

# Checking prerequisites
echo "Checking for prerequisites..."

# Installing necessary dependencies
echo "Installing necessary dependencies..."
sudo apt-get update
sudo apt-get install -y autoconf make gcc

# Downloading and installing mlmmj
echo "Downloading and installing mlmmj..."
git clone $SOURCE_URL mlmmj-source
pushd mlmmj-source
autoreconf -i && ./configure && make && sudo make install
popd
rm -rf mlmmj-source

# Creating mlmmj user and group
echo "Creating mlmmj user and group..."
sudo groupadd -f $MLMMJ_GROUP
sudo useradd -g $MLMMJ_GROUP -d $SPOOL_DIR -s /usr/sbin/nologin -r $MLMMJ_USER

# Creating spool directory for mlmmj
echo "Creating spool directory for mlmmj..."
sudo mkdir -p $SPOOL_DIR
sudo chown $MLMMJ_USER:$MLMMJ_GROUP $SPOOL_DIR
sudo chmod 750 $SPOOL_DIR

# Configuring Postfix for mlmmj
echo "Configuring Postfix for mlmmj..."
# At this stage, the configuration of Postfix for mlmmj is deferred
# until specific mailing lists are created via the configuration panel.

echo "mlmmj installation completed."
