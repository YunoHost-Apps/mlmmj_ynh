#!/bin/bash

# -------------------------------------------------------------
# mlmmj installation script for YunoHost
# -------------------------------------------------------------

# Import YunoHost helpers
source /usr/share/yunohost/helpers
source _common.sh

# -------------------------------------------------------------
# Current version
# -------------------------------------------------------------

# REQUIRED_VERSION="1.4.0.rc2"

# -------------------------------------------------------------
# Check name validity
# -------------------------------------------------------------

ynh_script_progression --message="Checking name validity;"

is_valid_listname() {
    # Check format
    if ! [[ $1 =~ ^[a-z0-9]+([.-][a-z0-9]+)*$ ]]; then
        ynh_print_err --message="Invalid mailing list name. It must be lowercase and can only contain letters, numbers, dots, and dashes."
        return 1
    fi

    # Check if name is a username
    if yunohost user list --output-as plain | grep -q "^$1$"; then
        ynh_print_err --message="The mailing list name '$1' is already in use as a username. Please choose a different name."
        return 1
    fi

    return 0
}

ynh_print_info --message="Validating list name: $list_name"

if ! is_valid_listname "$list_name"; then
    ynh_die --message="Validation failed for list name: $list_name"
fi

# -------------------------------------------------------------
# Install MLMMJ binaries if necessary
# -------------------------------------------------------------

ynh_script_progression --message="Checking existing mlmmj binaries;"
#REQUIRED_VERSION="1.4.0.rc2"
install_update_mlmmj "$REQUIRED_VERSION"
#REQUIRED_VERSION=$(cat ../mlmmj_version)
#INSTALLED_VERSION=""

#if command -v mlmmj-list >/dev/null 2>&1; then
#    INSTALLED_VERSION=$(mlmmj-list -V | cut -d ' ' -f3)
#    ynh_script_progression --message="mlmmj is already installed with version: $INSTALLED_VERSION"    
#    if [ "$REQUIRED_VERSION" != "$INSTALLED_VERSION" ]; then
#        ynh_script_progression --message="Updating mlmmj to the required version;"
#    fi
#else
#    ynh_script_progression --message="mlmmj is not installed, proceeding with installation;" -t
#fi

#if [ "$REQUIRED_VERSION" != "$INSTALLED_VERSION" ]; then
#    ynh_script_progression --message="Installing necessary packages" -t -w 5
#    ynh_install_app_dependencies autoconf make gcc pkg-config libatf-dev
#    ynh_script_progression --message="Downloading and installing mlmmj release;" -t
#    ynh_setup_source --dest_dir="mlmmj-latest"|| ynh_die "Failed to download mlmmj"
#    pushd mlmmj-latest
#    autoreconf -i && ./configure && make && sudo make install || ynh_die "Failed to install mlmmj binaries"
#    popd
#    ynh_secure_remove mlmmj-latest
#fi

# -------------------------------------------------------------
# Mailing List Creation and Activation
# -------------------------------------------------------------

ynh_script_progression --message="Creating the necessary directories in $install_dir;" -t
TEXTPATH="/usr/local/share/mlmmj/text.skel/$language"

for DIR in incoming queue queue/discarded archive text subconf unsubconf \
           bounce control moderation subscribers.d digesters.d requeue \
           nomailsubs.d
do
    mkdir -p "$install_dir/$DIR"
done

ynh_script_progression --message="Configuring the list $list_name@$domain" -t

echo "postmaster" > "$install_dir/control/owner"
echo "$list_name@$domain" > "$install_dir/control/listaddress"

if [ -d "$TEXTPATH" ]; then
    cp "$TEXTPATH"/* "$install_dir/text"
fi

# -------------------------------------------------------------
# Setting up conf files transport et virtual
# -------------------------------------------------------------

ynh_script_progression --message="Conf files update;" -t
# APP_ROOT="/var/spool/mlmmj"
TABLES_DIR="$APP_ROOT/tables"
TRANSPORT_FILE="$TABLES_DIR/transport"
VIRTUAL_FILE="$TABLES_DIR/virtual"
TRANSPORT_ENTRY="$app@localhost.mlmmj       mlmmj:$app"
VIRTUAL_ENTRY="$list_name@$domain    $app@localhost.mlmmj"

if [ ! -d "$TABLES_DIR" ]; then
    mkdir -p "$TABLES_DIR"
fi

if ! grep -qF "$TRANSPORT_ENTRY" "$TRANSPORT_FILE"; then
    echo "$TRANSPORT_ENTRY" >> "$TRANSPORT_FILE"
    postmap /var/spool/mlmmj/tables/transport
fi

if ! grep -qF "$VIRTUAL_ENTRY" "$VIRTUAL_FILE"; then
    echo "$VIRTUAL_ENTRY" >> "$VIRTUAL_FILE"
    postmap /var/spool/mlmmj/tables/virtual
fi

# -------------------------------------------------------------
# Symlinks for easier CLI administration
# -------------------------------------------------------------

SYMLINK_DIR="$APP_ROOT/$domain"
if [ ! -d "$SYMLINK_DIR" ]; then
    mkdir -p "$SYMLINK_DIR"
fi
ln -s "$install_dir" "$SYMLINK_DIR/$list_name"


# -------------------------------------------------------------
# Cron
# -------------------------------------------------------------

ynh_script_progression --message="Adding cron file;" -t
MLMMJRECEIVE="/usr/local/bin/mlmmj-receive"
MLMMJMAINTD="/usr/local/bin/mlmmj-maintd"

RAND_MIN=$(shuf -i 0-59 -n 1) # Generate random minute execution (between 0 and 59)
CRON_PATH="/etc/cron.d/$app"
mkdir -p $CRON_PATH
printf "$RAND_MIN */2 * * * root $MLMMJMAINTD -F -L $install_dir" > "$CRON_PATH/mlmmj.cron" 
chown root:root "$CRON_PATH"
chmod 644 "$CRON_PATH"

# -------------------------------------------------------------
# mlmmj installation script for YunoHost
# -------------------------------------------------------------

ynh_script_progression --message="Mailing list $list_name@$domain was created successfully." --last -t
