#!/bin/bash

# -------------------------------------------------------------
# mlmmj installation script for YunoHost
# -------------------------------------------------------------

# Variables
SOURCE_URL="https://codeberg.org/mlmmj/mlmmj"
SPOOL_DIR="/var/spool/mlmmj"
# MLMMJ_USER="nobody"
# MLMMJ_GROUP="nogroup"

# Checking prerequisites
echo "Checking for prerequisites..."

# Function to compare versions
version_gt() { test "$(echo "$@" | tr " " "\n" | sort -Vr | head -n 1)" == "$1"; }

# Checking if mlmmj is already installed and at the correct version
if command -v mlmmj-list >/dev/null 2>&1; then
    INSTALLED_VERSION=$(mlmmj-list -V | cut -d ' ' -f3)  # Extraction de la version
    REQUIRED_VERSION="1.4.0 rc2"  # Remplacez par la version requise pour votre package

    echo "mlmmj is already installed with version: $INSTALLED_VERSION"
    if version_gt $REQUIRED_VERSION $INSTALLED_VERSION; then
        echo "Updating mlmmj to the required version..."
            # Compiling latest version of mlmmj
            echo "Installing necessary dependencies..."
            ynh_install_app_dependencies autoconf make gcc libatf
        
            # Downloading and installing mlmmj
            echo "Downloading and installing mlmmj..."
            ynh_setup_source "$SOURCE_URL" mlmmj-source
            pushd mlmmj-source
            autoreconf -i && ./configure && make && sudo make install
            popd
            ynh_secure_remove mlmmj-source
    fi
fi

# Creating spool directory for mlmmj
# echo "Creating spool directory for mlmmj..."
# sudo mkdir -p $SPOOL_DIR
# sudo chown $MLMMJ_USER:$MLMMJ_GROUP $SPOOL_DIR
# sudo chmod 750 $SPOOL_DIR

# Retrieve arguments from TOML configuration
list_name=$(ynh_app_setting_get --app=$app --key=list_name)
domain=$(ynh_app_setting_get --app=$app --key=domain)

# Creating the mailing list
echo "Creating the mailing list..."
/usr/local/bin/mlmmj-make-ml -L $list_name -d $domain -a

# Running newaliases
echo "Running newaliases to update aliases..."
newaliases

# Activating and starting the mlmmj-maintd service
echo "Activating and starting the mlmmj-maintd service..."
ynh_systemd_action --service_name=mlmmj-maintd@$list_name.service --action=enable
ynh_systemd_action --service_name=mlmmj-maintd@list_name.service --action=start

echo "mlmmj installation and configuration completed."
